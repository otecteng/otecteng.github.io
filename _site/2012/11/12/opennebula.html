<!DOCTYPE html>
<html><head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link href="http://libs.baidu.com/bootstrap/2.0.4/css/bootstrap.min.css" rel="stylesheet">
<link href="/stylesheets/style.css" rel="stylesheet">
<link href="/stylesheets/code.css" rel="stylesheet">
<style type="text/css">
p {line-height: 1.7em;}
li {
line-height: 1.7em;
}
  h3 {
    font-family: Georgia, 'Times New Roman', Times, Kai, 'Kaiti SC', KaiTi, BiauKai, 楷体, 楷体_GB2312, serif;
    font-size: 33px;
    font-weight: bold;
    height: 40px;
    line-height: 40px;    
  }
  h4 {
    font-family: Georgia, 'Times New Roman', Times, Kai, 'Kaiti SC', KaiTi, BiauKai, 楷体, 楷体_GB2312, serif;
    font-size: 30px;
    font-weight: bold;
    height: 40px;
    line-height: 40px;    
  }
    h5 {
    font-family: GGeorgia, 'Times New Roman', Times, Kai, 'Kaiti SC', KaiTi, BiauKai, 楷体, 楷体_GB2312, serif;
    font-size: 22px;
    font-weight: bold;
    height: 30px;
    line-height: 30px;    
  }
</style>
<title>Opennebula测试系统的安装</title>
</head>
<body>
    <div class=container>
      <div class="row">
        <div class="offset2 span8">
<header>
  <div class=row>
    <div id=logo class=span5>
      <a href="/index.html">Teng</a>
    </div>
    <nav class=span3>
    <ul id=menu>
      <li class=" "><a href="/index.html">Home</a></li>
      <li class="current"><a href="/blog.html">Blog</a></li>
      <li class=" "><a href="/about.html">About</a></li>
    </ul>
    </nav>
  </div>
</header>

<div id=main>
<article>
<h2 id="opennebula">Opennebula测试系统的安装</h2>

<p><br /></p>

<p>之前我们的<a href="http://opennebula.org">Opennebula</a>系统由1个管理节点和2个计算节点组成，都运行在centos上，试用了几个月效果挺好，后来就把主要的项目测试都跑在上面，再后来把svn和maven nexus都用kvm来跑了。系统用了大概半年，一直都不错，但是上周管理节点的存储意外坏掉，花了大约一周的时间才把所有的内容恢复，基本过程比较顺利，有一些细节问题需要记录一下备忘。</p>

<h3 id="">基本结构</h3>

<p>采用ubuntu11.04+opennebula3.0,安装过程基本参照婉兮清扬的<a href="http://www.qyjohn.net/?p=1581">这篇文章</a>，修改了两个地方:<br />管理节点的nfs设置，原文</p>

<pre><code>/srv/cloud  *(rw,fsid=0,nohide,sync,root_squash,no_subtree_check)  </code></pre>

<p>修改为</p>

<pre><code>/srv/cloud  *(rw,fsid=0,nohide,async,no_root_squash,no_subtree_check)  </code></pre>

<p>如果no_root_squash不设置的话，计算节点上的chown oneadmin:cloud /srv/cloud/会执行失败。async的设置是我觉得kvm运行的有点慢，就设置了一下，不知道是不是真的有必要设置。<br /><br /></p>

<p>计算节点的kvm设置：<br />需要增加一个link，否则在virsh的create时会报/usr/libexec/qemu-kvm找不到的错误，这点原文没讲到。</p>

<pre><code>ln -sf /usr/share/qemu-kvm /usr/libexec/qemu-kvm  </code></pre>

<p><br /></p>

<h3 id="_2">制作虚拟机模板时遇到的几个问题</h3>

<p>vnc端口错误，模板文件设置了vnc端口，导致第2个实例无法启动，没有vnc时又很难排错，这个问题困扰了我两天，最后解决的办法很简单，不要设置vnc的端口即可。 disk bus的选择：默认选择总是ide(?)，在运行windows2003的实例时很慢，刚开始以为是nfs的设置问题，后来将disk bus从ide更换成virtio，速度就比较理想了，同样的问题也出现在ubuntu的实例上.</p>

<h3 id="_3">几个重要的日志的位置</h3>

<p>以oneadmin用户为登录用户，~/var/下面的oned.log和sched.log，跟opennebula相关的问题从里面基本上都能找到答案。计算节点的/var/log/libvirt/qemu目录下的实例日志，对于单个实例的运行失败查错很有用。<br /><br /></p>

<h3 id="vmcontext">vmcontext的编写</h3>

<p>ubuntu按照opennebula的文档做就可以了，centos5.8的vmcontext按照文档没做好，最后懒得想，直接放到rc.local里去运行，结果还不错，windows server2003和windows 7的vmcontext用ruby各写了一个脚本，放到计划任务启动项执行。</p>
</article>
</div>
          <footer>
<div class=row>
  <div class=span5>
    <a href="mailto:89172779@qq.com"><img alt="Drop me a line" src="/images/gmail.png"></a>
  </div>
  <div class=span3>
    Hosted on <a href="http://pages.github.com/">github</a>,
    generated by <a href="http://jekyllrb.com/">jekyll</a>.
  </div>
</div>
</footer>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-41177171-1', 'goxplanet.com');
  ga('send', 'pageview');

</script>
<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fb8cffd447977b8675e60de57e72cf87c' type='text/javascript'%3E%3C/script%3E"));
</script>
</body>
</html>
